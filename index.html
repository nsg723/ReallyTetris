<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Really Tetris</title>

<style>
    body {
        background: #C0C0C0;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        overflow: hidden; /* still blocks arrow-key scrolling */

        /* Horizontal centering only */
        display: flex;
        justify-content: center;

        /* Put it at the top, no vertical centering */
        align-items: flex-start;
        height: 100vh;
    }

    #game-container {
        width: 500px;
        max-width: 95vw;

        /* Start at exact top */
        margin-top: 0;

        /* Scaling for small screens */
        transform: scale(1);
        transform-origin: top center;

        border: 3px solid #000;
        background: #E0E0E0;
    }

    /* Auto-scale based on height */
    @media (max-height: 720px) {
        #game-container { transform: scale(0.9); }
    }
    @media (max-height: 650px) {
        #game-container { transform: scale(0.8); }
    }
    @media (max-height: 580px) {
        #game-container { transform: scale(0.7); }
    }
    @media (max-height: 500px) {
        #game-container { transform: scale(0.6); }
    }

    #title {
        background: linear-gradient(#FFFFFF, #DDDDDD);
        color: black;
        font-weight: bold;
        text-align: center;
        padding: 10px;
        border-bottom: 3px solid black;
        font-size: 20px;
    }

    #board {
        width: 300px;
        height: 600px;
        border: 3px solid black;
        margin: 15px auto;
        background: #FFFFFF;
        image-rendering: pixelated;
    }

    .cell {
        width: 30px;
        height: 30px;
        float: left;
        border: 1px solid #999;
        box-sizing: border-box;
    }
</style>
</head>
<body>

<div id="game-container">
    <div id="title">REALLY TETRIS</div>
    <div id="board"></div>
    <div id="stats" style="text-align:center; margin-top:10px;">
    Score: <span id="score">0</span> | Lines: <span id="lines">0</span>
</div>
</div>

<script>
let gameOver = false;
let score = 0;
let linesCleared = 0;
// ---------------------
// Prevent arrow scrolling
// ---------------------
window.addEventListener("keydown", function(e) {
    if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].includes(e.code)) {
        e.preventDefault();
    }
}, { passive: false });


// ---------------------
// Board Setup
// ---------------------
const COLS = 10;
const ROWS = 20;

const boardElem = document.getElementById("board");

let board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));

function createBoardHTML() {
    boardElem.innerHTML = "";
    for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
            const cell = document.createElement("div");
            cell.className = "cell";
            if (board[r][c] !== 0) {
                cell.style.background = board[r][c];
            } else {
                cell.style.background = "#FFFFFF";
            }
            boardElem.appendChild(cell);
        }
    }
}

// ---------------------
// Generate 900+ pieces
// ---------------------
function generateCrazyPiece() {
    const sizes = [
        [2, 2], [2, 3], [3, 2], [3, 3]
    ];
    const [h, w] = sizes[Math.floor(Math.random() * sizes.length)];

    // Max number of blocks = random between 2 and total cells
    const maxBlocks = h * w;
    const blockCount = Math.floor(Math.random() * (maxBlocks - 1)) + 2;

    // Initialize empty grid
    let shape = Array.from({ length: h }, () => Array(w).fill(0));

    // Start position
    let r = Math.floor(Math.random() * h);
    let c = Math.floor(Math.random() * w);
    shape[r][c] = 1;

    // List of frontier cells (for linear growth)
    let frontier = [[r, c]];

    while (frontier.length > 0 && shape.flat().reduce((a,b)=>a+b,0) < blockCount) {
        // Take the last cell to ensure compact growth
        const [cr, cc] = frontier.pop();

        // Shuffle directions
        const dirs = [[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-0.5);

        for (const [dr, dc] of dirs) {
            const nr = cr + dr;
            const nc = cc + dc;

            if (nr >= 0 && nr < h && nc >=0 && nc < w && shape[nr][nc] === 0) {
                shape[nr][nc] = 1;
                frontier.push([nr,nc]);
                break; // only one step at a time â†’ keeps shape thin
            }
        }
    }

    const colors = ["#FF0000", "#00AAFF", "#00CC00", "#FF00FF", "#FFA500", "#7700FF", "#009999"];
    return {
        shape,
        color: colors[Math.floor(Math.random() * colors.length)]
    };
}
// ---------------------
// Piece movement logic
// ---------------------
let current = spawnPiece();

function spawnPiece() {
    const newPiece = generateCrazyPiece();
    newPiece.r = 0; // top row
    newPiece.c = Math.floor((COLS - newPiece.shape[0].length) / 2);

    // Check if new piece fits
    if (!canMove(newPiece, 0, 0)) {
        gameOver = true;
        alert("GAME OVER!");
        return null;
    }

    return newPiece;
}

function rotate(piece) {
    const s = piece.shape;
    const rotated = s[0].map((_, c) => s.map(row => row[c]).reverse());
    return rotated;
}

function canMove(piece, dr, dc, newShape = null) {
    const shape = newShape || piece.shape;
    for (let r = 0; r < shape.length; r++) {
        for (let c = 0; c < shape[0].length; c++) {
            if (shape[r][c] === 1) {
                let nr = piece.r + r + dr;
                let nc = piece.c + c + dc;

                if (nr < 0 || nr >= ROWS || nc < 0 || nc >= COLS) return false;
                if (board[nr][nc] !== 0) return false;
            }
        }
    }
    return true;
}

function mergePiece(piece) {
    let landedBlocks = 0;
    for (let r = 0; r < piece.shape.length; r++) {
        for (let c = 0; c < piece.shape[0].length; c++) {
            if (piece.shape[r][c] === 1) {
                const br = piece.r + r;
                const bc = piece.c + c;
                if (br >= 0 && br < ROWS && bc >= 0 && bc < COLS) {
                    board[br][bc] = piece.color;
                    landedBlocks++;
                }
            }
        }
    }

    // Add points for landing a piece
    score += landedBlocks;
}

function clearLines() {
    let cleared = 0;
    board = board.filter(row => {
        if (row.every(cell => cell !== 0)) {
            cleared++;
            return false; // remove full line
        }
        return true;
    });

    // Add empty rows on top
    while (board.length < ROWS) {
        board.unshift(Array(COLS).fill(0));
    }

    if (cleared > 0) {
        linesCleared += cleared;

        // Extra points per cleared line
        score += cleared * 10; // for example, 10 points per line
    }

    // Update HTML stats
    document.getElementById('score').textContent = score;
    document.getElementById('lines').textContent = linesCleared;
}

function gameLoop() {
    if (gameOver) return;

    if (canMove(current, 1, 0)) {
        current.r++;
    } else {
        mergePiece(current);   // adds points for landed piece
        clearLines();          // adds points for cleared lines
        current = spawnPiece();
        if (!current) return; // game over
    }
    draw();
}

function draw() {
    let tempBoard = board.map(r => [...r]);
    const s = current.shape;

    for (let r = 0; r < s.length; r++) {
        for (let c = 0; c < s[0].length; c++) {
            if (s[r][c] === 1) {
                const br = current.r + r;
                const bc = current.c + c;

                if (br >= 0 && br < ROWS && bc >= 0 && bc < COLS) {
                    tempBoard[br][bc] = current.color;
                }
            }
        }
    }

    // render
    boardElem.innerHTML = "";
    for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
            const cell = document.createElement("div");
            cell.className = "cell";
            cell.style.background = tempBoard[r][c] === 0 ? "#FFFFFF" : tempBoard[r][c];
            boardElem.appendChild(cell);
        }
    }
}

// ---------------------
// Controls
// ---------------------
document.addEventListener("keydown", e => {
    if (e.code === "ArrowLeft" && canMove(current, 0, -1)) current.c--;
    if (e.code === "ArrowRight" && canMove(current, 0, 1)) current.c++;
    if (e.code === "ArrowDown" && canMove(current, 1, 0)) current.r++;
    if (e.code === "ArrowUp") {
        const rotated = rotate(current);
        if (canMove(current, 0, 0, rotated)) current.shape = rotated;
    }
    draw();
});

setInterval(gameLoop, 500);
createBoardHTML();
draw();
</script>
</body>
</html>
